<!doctype html>
<html  lang="zh-CN" >

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="generator" content="pandoc" />
    <!--  author -->
    <meta name="author" content="yoje" />
    <!--  date -->
    <meta name="date" content="2018-01-07" />     <!--  title -->
    <title>UseCondCardMark</title>
    <!--  ç½‘ç«™å›¾æ ‡ -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <link rel="apple-touch-icon-precomposed" href="/favicon.png">
    <!--  css -->
        <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.css" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">


    <!--  js  -->
    <script src="https://cdn.bootcss.com/jquery/3.1.1/jquery.slim.min.js" integrity="sha384-A7FZj7v+d/sdmMqp/nOQwliLvUsJfDHW+k9Omg/a/EheAdgtzNs3hpfag6Ed950n" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


    <!--[if lt IE 9]>
      <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
    <![endif]-->
</head>

<body>
    <div class="container">
        <header class="header ">
            <div class="avatar ">
                <img src="http://oscbgsllb.bkt.clouddn.com/me.jpg" class="img-circle" alt="where ma i" width="150px " height="150px ">
                <p class="avatar-desc">boma ye</p>
            </div>
            <div class="menu ">
                <div class="menu-item ">
                    <a class="menu-item-link" href="/"><span>blog</span></a>
                </div>
                <div class="menu-item ">
                    <a class="menu-item-link" href="/"><span>slide</span></a>
                </div>
                <div class="menu-item  ">
                    <a class="menu-item-link" href="#"><span>tag</span></a>
                </div>
            </div>
            <div class="feed ">
                <a class="feed-link " href="# "><i class="fa fa-rss fa-2x " aria-hidden="true "></i> <span>RSS</span></a>
            </div>
            <div class="contact ">
                <a class="contact-link " href="https://github.com/huangyoje"><i class="fa fa-github fa-fw" aria-hidden="true "></i> </a>
                <a class="contact-link " href="https://plus.google.com/115454074587838046879"><i class="fa fa-google-plus" aria-hidden="true"></i> </a>
                <a class="contact-link " href="https://twitter.com/huayoje"><i class="fa fa-twitter fa-fw" aria-hidden="true "></i> </a>
            </div>
        </header>
        <main class="content " role="main ">
            <!--  åšå®¢ -->
            <article class="post ">
                <!--  åšå®¢æ ‡é¢˜ -->
                <header id="title">
                    <h1>UseCondCardMark</h1>
                    <small>2018-01-07</small>
                </header>
                <!--  åšå®¢æ­£æ–‡ -->
                <h2 id="cardtable">CardTable</h2>
                <p>åˆ†ä»£åƒåœ¾å›æ”¶å™¨ä¸­, é™¤äº†full gcä¼šå›æ”¶æ•´ä¸ªå †å†…å­˜, å…¶ä½™çš„gcé€šå¸¸åªä¼šå›æ”¶éƒ¨åˆ†å †ç©ºé—´ã€‚card tableåˆ™æ˜¯ä¸ºäº†å®ç°éƒ¨åˆ†åƒåœ¾å›æ”¶æ—¶ä½¿ç”¨åˆ°çš„æ•°æ®ç»“æ„.</p>
                <p><a href="https://stackoverflow.com/questions/19154607/how-actually-card-table-and-writer-barrier-works" class="uri">https://stackoverflow.com/questions/19154607/how-actually-card-table-and-writer-barrier-works</a> <a href="https://blogs.msdn.microsoft.com/abhinaba/2009/03/02/back-to-basics-generational-garbage-collection/" class="uri">https://blogs.msdn.microsoft.com/abhinaba/2009/03/02/back-to-basics-generational-garbage-collection/</a></p>
                <h2 id="cardtable-overhead">CardTable overhead</h2>
                <p>é€šè¿‡ä½¿ç”¨cardtable, åœ¨ä¸€æ¬¡ygcä¸­,å¯ä»¥å¿«é€Ÿçš„æ‰¾åˆ°old generationå¼•ç”¨çš„young generationçš„å¯¹è±¡,ä»è€ŒåŠ å¿«ygcæ ‡è®°å­˜æ´»å¯¹è±¡çš„é€Ÿåº¦.ä½†æ˜¯ä¸ºäº†ä½¿ç”¨cardtableè®°å½•è·¨ä»£çš„å¼•ç”¨å…³ç³», éœ€è¦ä½¿ç”¨write barrierè®°å½•å¼•ç”¨çš„ä¿®æ”¹çŠ¶æ€. è¿™å¸¦æ¥çš„é—®é¢˜æœ‰ä¸¤ä¸ª: 1. ä½¿ç”¨write barrierå¸¦æ¥çš„é¢å¤–æŒ‡ä»¤æ¶ˆè€— 2. card tableçš„ä¿®æ”¹å¸¦æ¥çš„ä¼ªå…±äº« åœ¨hotspot jvmçš„card tableå®ç°ä¸­, ä½¿ç”¨1byteè¡¨ç¤º512bytes(card page size)çš„ç©ºé—´. ä¹Ÿå°±æ˜¯å¦‚æœè¿™512bytesçš„å†…å­˜ä¸­è¿›è¡Œå¼•ç”¨å…³ç³»çš„ä¿®æ”¹æ—¶, ä¼šå¯¹è¿™ä¸ª512bytesç©ºé—´å¯¹åº”çš„card tableä¸­çš„é‚£ä¸ªå­—èŠ‚è¿›è¡Œæ ‡è®°. è€Œcard tableæ˜¯ä½¿ç”¨å­—èŠ‚<font color=green>æ•°ç»„</font>å®ç°çš„, ä¹Ÿå°±æ„å‘³ç€card tableåœ¨å ç”¨ä¸€ç‰‡è¿ç»­çš„å†…å­˜ç©ºé—´ã€‚ ç°ä»£cpuå’Œä¸»å†…å­˜ä¹‹é—´,é€šå¸¸éƒ½æœ‰å¤šçº§ç¼“å­˜ï¼Œè¿™äº›ç¼“å­˜çš„åŸºæœ¬å•ä½æ˜¯cache lineã€‚ å‡è®¾cache lineçš„å¤§å°æ˜¯64bytes(ç°åœ¨å¤§å¤šæ•°çš„æ¶æ„éƒ½æ˜¯64bytes)ï¼Œå¦‚æœä¸€ä¸ªcache lineç¼“å­˜äº†card table, åˆ™è¯¥cache lineæ‰€å­˜å‚¨çš„card table å¯¹åº”çš„å†…å­˜ç©ºé—´æ˜¯ 64 * 512 bytes = 32KBï¼Œå¦‚æœå¤šä¸ªæ ¸å¹¶å‘åœ°ä¿®æ”¹è¿™32KBçš„ç©ºé—´é‡Œçš„å¼•ç”¨ï¼Œæ¯ä¸ªæ ¸éƒ½ä¼šå°†è¿™32KBå†…å­˜å¯¹åº”çš„card tableç¼“å­˜åˆ°è‡ªå·±çš„cache lineä¸­ï¼Œä¸€ä¸ªæ ¸ä¿®æ”¹ä¹‹åï¼Œå¿…å®šå¯¼è‡´å…¶å®ƒæ ¸cache lineçš„æ•°æ®å¤±æ•ˆï¼Œä»è€Œç©¿é€cache, è®¿é—®ä¸»å†…å­˜ã€‚ è€Œåœ¨å†™å¹¶å‘åº¦éå¸¸é«˜çš„åº”ç”¨ä¸­ï¼Œè¿™ä¼šå¯¹æ€§èƒ½é€ æˆå¾ˆå¤§çš„ä¼¤å®³ã€‚</p>
                <h2 id="demo">demo</h2>
                <p>é€šè¿‡ä¸€æ®µä»£ç è¯´æ˜ä¸€ä¸‹ä¸Šé¢çš„ä¸¤ç‚¹ã€‚</p>
                <div class="sourceCode" id="cb1"><pre class="sourceCode java"><code class="sourceCode java"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">public</span> <span class="kw">class</span> CardTableTest {</a>
                <a class="sourceLine" id="cb1-2" data-line-number="2"></a>
                <a class="sourceLine" id="cb1-3" data-line-number="3">    <span class="kw">class</span> Worker <span class="kw">extends</span> <span class="bu">Thread</span> {</a>
                <a class="sourceLine" id="cb1-4" data-line-number="4">        <span class="bu">String</span>[] array = <span class="kw">new</span> <span class="bu">String</span>[<span class="dv">10</span>];</a>
                <a class="sourceLine" id="cb1-5" data-line-number="5">        <span class="co">// ä½¿ç”¨longæ•°ç»„è¿›è¡Œå¡«å……, 32KBå†…å­˜</span></a>
                <a class="sourceLine" id="cb1-6" data-line-number="6">        <span class="co">// long[] padding = new long[4096];</span></a>
                <a class="sourceLine" id="cb1-7" data-line-number="7">        <span class="dt">int</span> times;</a>
                <a class="sourceLine" id="cb1-8" data-line-number="8"></a>
                <a class="sourceLine" id="cb1-9" data-line-number="9">        <span class="kw">public</span> <span class="fu">Worker</span>(<span class="dt">int</span> times) {</a>
                <a class="sourceLine" id="cb1-10" data-line-number="10">            <span class="kw">this</span>.<span class="fu">times</span> = times;</a>
                <a class="sourceLine" id="cb1-11" data-line-number="11">        }</a>
                <a class="sourceLine" id="cb1-12" data-line-number="12"></a>
                <a class="sourceLine" id="cb1-13" data-line-number="13">        <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>() {</a>
                <a class="sourceLine" id="cb1-14" data-line-number="14">            <span class="bu">String</span>[] arr = array;</a>
                <a class="sourceLine" id="cb1-15" data-line-number="15">            <span class="dt">int</span> i = <span class="dv">0</span>;</a>
                <a class="sourceLine" id="cb1-16" data-line-number="16">            <span class="dt">int</span> pos = <span class="dv">5</span>;</a>
                <a class="sourceLine" id="cb1-17" data-line-number="17">            <span class="bu">String</span> v = <span class="kw">new</span> <span class="bu">String</span>(<span class="st">&quot;hello&quot;</span>);</a>
                <a class="sourceLine" id="cb1-18" data-line-number="18">            <span class="kw">while</span> (i &lt; times) {</a>
                <a class="sourceLine" id="cb1-19" data-line-number="19">                <span class="kw">if</span> (i % <span class="dv">2</span> == <span class="dv">0</span>) {</a>
                <a class="sourceLine" id="cb1-20" data-line-number="20">                    arr[pos] = v;</a>
                <a class="sourceLine" id="cb1-21" data-line-number="21">                    pos += <span class="dv">1</span>;</a>
                <a class="sourceLine" id="cb1-22" data-line-number="22">                } <span class="kw">else</span> {</a>
                <a class="sourceLine" id="cb1-23" data-line-number="23">                    pos -= <span class="dv">1</span>;</a>
                <a class="sourceLine" id="cb1-24" data-line-number="24">                    v = arr[pos];</a>
                <a class="sourceLine" id="cb1-25" data-line-number="25">                }</a>
                <a class="sourceLine" id="cb1-26" data-line-number="26">                i++;</a>
                <a class="sourceLine" id="cb1-27" data-line-number="27">            }</a>
                <a class="sourceLine" id="cb1-28" data-line-number="28">        }</a>
                <a class="sourceLine" id="cb1-29" data-line-number="29">    }</a>
                <a class="sourceLine" id="cb1-30" data-line-number="30"></a>
                <a class="sourceLine" id="cb1-31" data-line-number="31">    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">void</span> <span class="fu">main</span>(<span class="bu">String</span>[] args) {</a>
                <a class="sourceLine" id="cb1-32" data-line-number="32"></a>
                <a class="sourceLine" id="cb1-33" data-line-number="33">        <span class="kw">if</span> (args == <span class="kw">null</span> || args.<span class="fu">length</span> != <span class="dv">3</span>) {</a>
                <a class="sourceLine" id="cb1-34" data-line-number="34">            <span class="kw">throw</span> <span class="kw">new</span> <span class="bu">IllegalArgumentException</span>(<span class="st">&quot;java CardTableTest size parallelLevel count&quot;</span>);</a>
                <a class="sourceLine" id="cb1-35" data-line-number="35">        }</a>
                <a class="sourceLine" id="cb1-36" data-line-number="36">        <span class="dt">int</span> size = <span class="bu">Integer</span>.<span class="fu">parseInt</span>(args[<span class="dv">0</span>]);</a>
                <a class="sourceLine" id="cb1-37" data-line-number="37">        <span class="dt">int</span> parallelLevel = <span class="bu">Integer</span>.<span class="fu">parseInt</span>(args[<span class="dv">1</span>]);</a>
                <a class="sourceLine" id="cb1-38" data-line-number="38">        <span class="dt">int</span> count = <span class="bu">Integer</span>.<span class="fu">parseInt</span>(args[<span class="dv">2</span>]);</a>
                <a class="sourceLine" id="cb1-39" data-line-number="39"></a>
                <a class="sourceLine" id="cb1-40" data-line-number="40">        <span class="bu">ArrayList</span>&lt;<span class="bu">Long</span>&gt; measurements = <span class="kw">new</span> <span class="bu">ArrayList</span>&lt;&gt;();</a>
                <a class="sourceLine" id="cb1-41" data-line-number="41">        CardTableTest cardTableTest = <span class="kw">new</span> <span class="fu">CardTableTest</span>();</a>
                <a class="sourceLine" id="cb1-42" data-line-number="42">        <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; count; i++) {</a>
                <a class="sourceLine" id="cb1-43" data-line-number="43">            <span class="dt">long</span> start = <span class="bu">System</span>.<span class="fu">currentTimeMillis</span>();</a>
                <a class="sourceLine" id="cb1-44" data-line-number="44">            cardTableTest.<span class="fu">run</span>(size, parallelLevel);</a>
                <a class="sourceLine" id="cb1-45" data-line-number="45">            measurements.<span class="fu">add</span>(<span class="bu">System</span>.<span class="fu">currentTimeMillis</span>() - start);</a>
                <a class="sourceLine" id="cb1-46" data-line-number="46">        }</a>
                <a class="sourceLine" id="cb1-47" data-line-number="47">        <span class="bu">System</span>.<span class="fu">out</span>.<span class="fu">println</span>(<span class="st">&quot;running times: &quot;</span> + measurements);</a>
                <a class="sourceLine" id="cb1-48" data-line-number="48">    }</a>
                <a class="sourceLine" id="cb1-49" data-line-number="49"></a>
                <a class="sourceLine" id="cb1-50" data-line-number="50">    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">run</span>(<span class="dt">int</span> size, <span class="dt">int</span> parrelLevel) {</a>
                <a class="sourceLine" id="cb1-51" data-line-number="51">        <span class="dt">int</span> sz = size / parrelLevel;</a>
                <a class="sourceLine" id="cb1-52" data-line-number="52">        <span class="bu">ArrayList</span>&lt;<span class="bu">Thread</span>&gt; threads = <span class="kw">new</span> <span class="bu">ArrayList</span>&lt;&gt;();</a>
                <a class="sourceLine" id="cb1-53" data-line-number="53">        <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; parrelLevel; i++) {</a>
                <a class="sourceLine" id="cb1-54" data-line-number="54">            threads.<span class="fu">add</span>(<span class="kw">new</span> <span class="fu">Worker</span>(sz));</a>
                <a class="sourceLine" id="cb1-55" data-line-number="55">            threads.<span class="fu">get</span>(i).<span class="fu">start</span>();</a>
                <a class="sourceLine" id="cb1-56" data-line-number="56">        }</a>
                <a class="sourceLine" id="cb1-57" data-line-number="57">        <span class="kw">for</span> (<span class="dt">int</span> i = <span class="dv">0</span>; i &lt; parrelLevel; i++) {</a>
                <a class="sourceLine" id="cb1-58" data-line-number="58">            <span class="kw">try</span> {</a>
                <a class="sourceLine" id="cb1-59" data-line-number="59">                threads.<span class="fu">get</span>(i).<span class="fu">join</span>();</a>
                <a class="sourceLine" id="cb1-60" data-line-number="60">            } <span class="kw">catch</span> (<span class="bu">Exception</span> e) {</a>
                <a class="sourceLine" id="cb1-61" data-line-number="61">            }</a>
                <a class="sourceLine" id="cb1-62" data-line-number="62">        }</a>
                <a class="sourceLine" id="cb1-63" data-line-number="63">    }</a>
                <a class="sourceLine" id="cb1-64" data-line-number="64">}</a></code></pre></div>
                <p>ä»£ç æ¥è‡ªopen jdkçš„æŸä¸ªé‚®ä»¶(æ‰¾ä¸åˆ°åŸå§‹é“¾æ¥)ã€‚ åšçš„äº‹æƒ…æ˜¯å¯¹æ•°ç»„çš„æŸä¸ªå…ƒç´ è¿›è¡Œä¸€å®šæ¬¡æ•°çš„è¯»å†™æ“ä½œï¼ŒæŒ‰ç…§é“ç†æ¥è®²ï¼Œè¿™æ®µç¨‹åºçš„æ‰§è¡Œæ—¶é—´éšç€å¹¶å‘åº¦æé«˜ä¼šçº¿æ€§å‡å°ã€‚</p>
                <h2 id="test">test</h2>
                <p>å¯¹ä¸Šé¢ä»£ç ç¼–è¯‘åé€šè¿‡<code>java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc CardTableTest 2000000000 4 5</code> æ‰§è¡Œ, æ‰“å°gcæ˜¯ä¸ºäº†è§‚å¯Ÿgcæ—¥å¿—, ä¿è¯æµ‹è¯•ç»“æœä¸å—gcå½±å“,å¦‚æœæµ‹è¯•æœŸé—´å‡ºç°äº†gc, åˆ™é€šè¿‡è°ƒæ•´å †å¤§å°é¿å…ã€‚2000000000 æ˜¯è¿›è¡Œè¯»å†™çš„æ€»æ¬¡æ•°ï¼Œ4æ˜¯å¹¶å‘åº¦ï¼Œ 5æ˜¯æµ‹è¯•æ¬¡æ•°ã€‚ è¿è¡Œç¯å¢ƒ: linux 2.6.32-358.23.2.el6.x86_64, 24æ ¸, java version 1.8.0_91</p>
                <pre><code>// å¹¶å‘åº¦=1
                java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  CardTableTest 2000000000 1 5
                running times: [3813, 3826, 4541, 4399, 4341]
                // å¹¶å‘åº¦=2
                java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  CardTableTest 2000000000 2 5
                running times: [3414, 3490, 3430, 3421, 3417]
                // å¹¶å‘åº¦=4
                java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  CardTableTest 2000000000 4 5
                running times: [3749, 3694, 3640, 3673, 3660]
                // å¹¶å‘åº¦=8
                java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  CardTableTest 2000000000 8 5
                running times: [3726, 3594, 3637, 3726, 2733]</code></pre>
                <p>WTF. ğŸ˜  éš¾é“24æ ¸æ˜¯å‡çš„å—. å¹¶å‘åº¦çš„å¢åŠ å¯¹æ€§èƒ½çš„å½±å“å¾®ä¹å…¶å¾®.</p>
                <p>åˆ†æä¸€ä¸‹ä»£ç , <code>threads.add(new Worker(sz))</code>, è¿™é‡Œæ ¹æ®è®¾ç½®çš„å¹¶å‘åº¦åˆ›å»ºç›¸åº”æ•°é‡çš„çº¿ç¨‹,å¹¶å‘æ‰§è¡Œä»»åŠ¡ã€‚ä½†è¿™äº›å¹¶å‘çº¿ç¨‹éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹é‡Œåˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„Workerå¯¹è±¡éƒ½æ˜¯åˆ†é…åœ¨ä¸»çº¿ç¨‹çš„TLAB, å¹¶ä¸”ä½äºè¿ç»­çš„å†…å­˜ç©ºé—´. æ ¹æ®å‰é¢å¯¹card tableä¼ªå…±äº«çš„åˆ†æï¼Œå¯ä»¥çœ‹å‡ºæ‰€æœ‰çš„Workerå¯¹è±¡å¯èƒ½ä½äºåŒä¸€cache line, å¹¶ä¸”æ¯ä¸ªWorkerå¯¹è±¡ç”±å„è‡ªçš„çº¿ç¨‹è¿›è¡Œå¼•ç”¨è¯»å†™æ“ä½œ,æ‰€ä»¥card table å¸¦æ¥çš„ä¼ªå…±äº«å¯èƒ½ä¼šé€ æˆæ€§èƒ½ä¸‹é™ã€‚</p>
                <h2 id="xxusecondcardmark">-XX:+UseCondCardMark</h2>
                <p>é€šè¿‡ä½¿ç”¨<code>-XX:+UseCondCardMark</code>å¼€å¯æœ‰æ¡ä»¶åœ°card mark, å¯ä»¥è§£å†³ä¸Šé¢æ‹…å¿ƒçš„ä¼ªå…±äº«é—®é¢˜ã€‚ ä»¥A.a = bä¸ºä¾‹, jvmé»˜è®¤ä½¿ç”¨æ— æ¡ä»¶card mark, ä¼ªä»£ç å¦‚ä¸‹</p>
                <pre><code>æ‰¾åˆ°aåœ¨card tableä¸­å¯¹åº”çš„byteä½.
                å¯¹æ‰¾åˆ°çš„byteä½è¿›è¡Œæ ‡è®°.(è¿™ä¸€æ¬¡æ ‡è®°æ“ä½œè‚¯å®šä¼šè®©cache line å¤±æ•ˆ)
                æ‰§è¡ŒA.a = b æ“ä½œ.</code></pre>
                <p>æœ‰æ¡ä»¶çš„card markå¦‚ä¸‹</p>
                <pre><code>æ‰¾åˆ°aåœ¨card tableä¸­å¯¹åº”çš„byteä½.
                åˆ¤æ–­è¯¥byteä½æ˜¯å¦è¢«æ ‡è®°
                  å¦‚æœæ²¡æœ‰è¢«æ ‡è®°ï¼Œåˆ™å¯¹æ‰¾åˆ°çš„byteä½è¿›è¡Œæ ‡è®°.(è¿™ä¸€æ¬¡æ ‡è®°æ“ä½œè‚¯å®šä¼šè®©cache line å¤±æ•ˆ)
                æ‰§è¡ŒA.a = b æ“ä½œ.</code></pre>
                <p>é€šè¿‡åœ¨æ ‡è®°ä¹‹å‰ï¼Œå¢åŠ ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­, è™½ç„¶å¢åŠ äº†é¢å¤–çš„æŒ‡ä»¤,ä½†æ˜¯é¿å…äº†é’ˆå¯¹card tableä¸­ç›¸åŒbyteçš„æ ‡è®°æ“ä½œå¸¦æ¥çš„ä¼ªå…±äº«é—®é¢˜. æµ‹è¯•æ•°æ®å¦‚ä¸‹</p>
                <pre><code>// å¹¶å‘åº¦=4
                java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  -XX:+UseCondCardMark CardTableTest 2000000000 4 5
                running times: [1053, 1057, 1100, 1150, 1118]
                // å¹¶å‘åº¦=8
                java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  -XX:+UseCondCardMark CardTableTest 2000000000 8 5
                running times: [566, 563, 642, 621, 651]</code></pre>
                <p>Good Job!</p>
                <h2 id="è§‚å¯Ÿä¼ªå…±äº«é€ æˆçš„cacheå¤±æ•ˆ">è§‚å¯Ÿä¼ªå…±äº«é€ æˆçš„cacheå¤±æ•ˆ</h2>
                <p>ä½¿ç”¨ <a href="http://www.brendangregg.com/perf.html">perf</a> è§‚å¯Ÿcpuå’Œä¸»å†…å­˜ä¹‹é—´cacheçš„è®¿é—®æƒ…å†µ.</p>
                <h4 id="xx-usecondcardmark">1. -XX:-UseCondCardMark</h4>
                <p><code>sudo perf stat -ecycles,instructions,cache-references,cache-misses java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  -XX:-UseCondCardMark CardTableTest 2000000000 8 5</code></p>
                <pre><code>running times: [3668, 3820, 3527, 3623, 2456]
                
                 Performance counter stats for &#39;java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc -XX:-UseCondCardMark CardTableTest 2000000000 8 5&#39;:
                
                   380,627,593,591 cycles                    #    0.000 GHz
                   216,449,367,675 instructions              #    0.57  insns per cycle
                       344,499,146 cache-references
                       137,509,095 cache-misses              #   39.916 % of all cache refs
                
                      17.163011340 seconds time elapsed</code></pre>
                <h4 id="xxusecondcardmark-1">2. -XX:+UseCondCardMark</h4>
                <p><code>sudo perf stat -ecycles,instructions,cache-references,cache-misses java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc  -XX:+UseCondCardMark CardTableTest 2000000000 8 5</code></p>
                <pre><code>running times: [590, 574, 564, 541, 549]
                
                 Performance counter stats for &#39;java -XX:+UseParallelGC -Xms32m -Xmx32m -server -verbose:gc -XX:+UseCondCardMark CardTableTest 2000000000 8 5&#39;:
                
                    63,187,057,676 cycles                    #    0.000 GHz
                   219,369,504,739 instructions              #    3.47  insns per cycle
                        10,018,646 cache-references
                         3,616,081 cache-misses              #   36.094 % of all cache refs
                
                       2.884229639 seconds time elapsed</code></pre>
                <p>instructionsè¡¨ç¤ºcpuæ‰§è¡Œçš„æŒ‡ä»¤æ•°é‡. å¯ä»¥çœ‹åˆ°æ‰“å¼€<code>UseCondCardMark</code>åï¼Œæ‰§è¡Œçš„æŒ‡ä»¤æ•°é‡å¢åŠ äº†. cache-referencesè¡¨ç¤ºcpuè®¿é—®cacheçš„æ¬¡æ•°, cache-missesè¡¨ç¤ºè®¿é—®cacheå¤±è´¥çš„æ¬¡æ•°. cpuå’Œä¸»å†…å­˜ä¹‹é—´å­˜åœ¨ç€å¤šçº§ç¼“å­˜ï¼Œè¿™é‡Œç»Ÿè®¡çš„æ˜¯æœ€åä¸€çº§ç¼“å­˜çš„è®¿é—®æƒ…å†µã€‚cache-referencesçš„å€¼å¤ªé«˜, è¯´æ˜L1 cacheçš„missé‡æ¯”è¾ƒé«˜ï¼Œcpuç©¿é€äº†L1 cache. cache-missesæ•°å€¼å¤ªé«˜, è¡¨ç¤ºæ•°æ®å¤±æ•ˆæˆ–è€…æ²¡æœ‰åŠ è½½åˆ°æœ€åä¸€çº§cacheä¸­ã€‚è€Œä¼ªå…±äº«é€ æˆçš„é—®é¢˜æ˜¯å¯¼è‡´å¤šçº§ç¼“å­˜é‡Œçš„æ•°æ®å…¨éƒ½å¤±æ•ˆï¼Œå› æ­¤cache-referenceså’Œcache-missesçš„æ•°é‡éƒ½ä¼šå¢åŠ ã€‚ä¸Šé¢çš„æ•°æ®ä¹Ÿè¯´æ˜äº†è¿™ä¸€ç‚¹ã€‚</p>
                <h2 id="ç»“è®º">ç»“è®º</h2>
                <ol type="1">
                <li>Always use <code>-XX:+UseCondCardMark</code> in parallel garbage collector.</li>
                <li>g1 garbage collectorçš„å®ç°æœºåˆ¶é¿å…äº†è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨g1æµ‹è¯•ç»“æœå¦‚ä¸‹</li>
                </ol>
                <pre><code>java -XX:+UseG1GC -Xms32m -Xmx32m -server -verbose:gc  CardTableTest 2000000000 8 5
                running times: [702, 735, 839, 856, 837]</code></pre>
                <p>PS: æµ‹è¯•ä»£ç ä¸­, æœ‰ä¸€è¡Œæ³¨é‡Šçš„ä»£ç  <code>long[] padding = new long[4096];</code>ï¼Œè¿™é‡Œé€šè¿‡å¡«å……çš„æ–¹å¼, ä½¿å¾—æ¯ä¸ªWorkerå¯¹è±¡ä½äºä¸åŒçš„card page ä¸­ï¼Œè¿›è€Œä½¿å¾—å¯¹åº”çš„card tableä¸­çš„byteä¸ä¼šä½äºåŒä¸€ä¸ªcache line. ä½†æ˜¯è¿™ç§å¡«å……æ–¹å¼æœ‰æ—¶å€™æ•ˆæœæ˜æ˜¾ï¼Œæœ‰æ—¶å€™æ²¡æœ‰ä»»ä½•æ•ˆæœï¼Œå¯èƒ½æ˜¯ç”±äºjvmçš„å†…éƒ¨çš„ä¼˜åŒ–(é‡æ’æˆ–è€…æ— ç”¨å­—æ®µä¸¢å¼ƒ)å¯¼è‡´å¡«å……å¤±æ•ˆ.</p>
                <h2 id="references">references</h2>
                <p><a href="https://blogs.oracle.com/dave/false-sharing-induced-by-card-table-marking" class="uri">https://blogs.oracle.com/dave/false-sharing-induced-by-card-table-marking</a></p>
            </article>
            <!-- è¯„è®º -->
            <article class="comment ">
                <!-- å¤šè¯´è¯„è®ºæ¡† start -->
                <div class="ds-thread" data-thread-key="è¯·å°†æ­¤å¤„æ›¿æ¢æˆæ–‡ç« åœ¨ä½ çš„ç«™ç‚¹ä¸­çš„ID" data-title="è¯·æ›¿æ¢æˆæ–‡ç« çš„æ ‡é¢˜" data-url="è¯·æ›¿æ¢æˆæ–‡ç« çš„ç½‘å€"></div>
            </article>
        </main>
        <footer class="bottom cp ">
            <p>Copyright Â© 2017 yoje </p>
        </footer>
    </div>
    <!-- <div id="forkme ">
        <a href="https://github.com/huangyoje "><img src="https://camo.githubusercontent.com/52760788cde945287fbb584134c4cbc2bc36f904/68747470733a2f2f73332e616d617a6f6e6177732e636f6d2f6769746875622f726962626f6e732f666f726b6d655f72696768745f77686974655f6666666666662e706e67
                    " alt="Fork me on GitHub " data-canonical-src="https://s3.amazonaws.com/github/ribbons/forkme_right_white_ffffff.png "></a>
    </div> -->

</body>

</html>
